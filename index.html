
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Manuals Portal</title>

  <style>
    /* =========================
       THEME SYSTEM (Light/Dark)
       ========================= */
    :root { color-scheme: light dark; }

    :root[data-theme="light"] {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;            /* visible border in light */
      --border-soft: rgba(0,0,0,0.08);
      --link: #06416b;               /* neutral link color */
      --hover: rgba(0,0,0,0.06);     /* neutral hover for TOC */
      --quote-bg: rgba(0,0,0,0.04);  /* blockquote background (light) */
      --quote-border: rgba(0,0,0,0.5);
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    :root[data-theme="dark"] {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: rgba(255,255,255,0.10); /* faint border in dark */
      --border-soft: rgba(255,255,255,0.06);
      --link: #60a5fa;
      --hover: rgba(255,255,255,0.08);  /* neutral hover for TOC (no brand) */
      --quote-bg: rgba(255,255,255,0.05);  /* blockquote bg (very faint) */
      --quote-border: rgba(255,255,255,0.18);
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
    }

    /* Reset + Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(11,19,36,0.12), transparent),
        var(--bg);
      color: var(--text);
    }
    a { color: var(--link); text-decoration: none; }

    /* =========================
       Header
       ========================= */
    .site-header {
      position: sticky; top: 0; z-index: 100;
      display: grid;
      grid-template-columns: auto auto 1fr auto; /* menu, company logo, title, partner logo */
      align-items: center; gap: .75rem;
      padding: .6rem .9rem;
      background: color-mix(in oklab, var(--panel) 70%, transparent);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }

    .menu-btn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 38px; height: 38px;
      border: 1px solid var(--border);
      background: var(--panel); color: var(--text);
      border-radius: 10px; box-shadow: var(--shadow);
      cursor: pointer;
    }
    .menu-btn:hover { background: color-mix(in oklab, var(--panel) 88%, white 12%); }
    .menu-btn svg { width: 20px; height: 20px; }

    .logo { display: flex; align-items: center; height: 40px; }
    .logo img {
      max-height: 100%; max-width: 180px; object-fit: contain;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      cursor: pointer; /* clickable to go to Welcome page */
    }

    .site-title {
      text-align: center;
      font-style: italic;
      font-weight: 700;
      letter-spacing: 0.25px;
      font-size: clamp(1rem, 2.5vw, 1.25rem);
      color: var(--text);
    }

    /* =========================
       Main layout (Content + TOC)
       ========================= */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 320px; /* content + TOC */
      gap: 1rem; padding: 1rem; max-width: 1700px; margin: 0 auto;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .panel-header {
      padding: .6rem .8rem;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      background: color-mix(in oklab, var(--panel) 96%, white 4%);
    }
    .panel-header h2 { margin: 0; font-size: .95rem; font-weight: 600; color: var(--text); }

    .collapse-btn {
      display: inline-flex; align-items: center; gap: .35rem;
      font-size: .85rem; color: var(--muted);
      border: 1px solid var(--border);
      background: transparent;
      padding: .25rem .5rem; border-radius: 8px; cursor: pointer;
    }
    .collapse-btn:hover { background: transparent; color: var(--muted); }
    .panel.collapsed .panel-body { display: none; }
    .panel.collapsed { min-height: 48px; }

    /* Markdown rendering */
    .content .panel-body {
      overflow-y: auto; max-height: calc(100vh - 170px);
      padding: 1rem 1.25rem;
    }
    .markdown-body { line-height: 1.6; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3,
    .markdown-body h4, .markdown-body h5, .markdown-body h6 {
      margin: 1.2rem 0 .6rem;
      scroll-margin-top: 80px;          /* sticky header offset */
      text-decoration: none !important; /* remove underline */
      border-bottom: 0 !important;      /* remove any H2 rule */
    }
    .markdown-body h1 a, .markdown-body h2 a, .markdown-body h3 a,
    .markdown-body h4 a, .markdown-body h5 a, .markdown-body h6 a {
      text-decoration: none !important;
      border-bottom: 0 !important;
      color: inherit !important;
    }
    .markdown-body u { text-decoration: none !important; } /* neutralize underlines inside content */

    .markdown-body p { margin: .7rem 0; color: var(--text); }
    .markdown-body code { background: color-mix(in oklab, var(--panel) 85%, white 15%); padding: 0 .25rem; border-radius: 4px; }
    .markdown-body pre {
      background: color-mix(in oklab, var(--panel) 85%, white 15%);
      border: 1px solid var(--border); border-radius: 10px; padding: .9rem; overflow: auto;
    }
    .markdown-body table { width: 100%; border-collapse: collapse; margin: .8rem 0; font-size: .95rem; }
    .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: .5rem .6rem; }
    .markdown-body img { max-width: 100%; height: auto; border-radius: 8px; }
    /* Blockquotes: visible in light, very faint in dark */
    .markdown-body blockquote {
      margin: 1rem 0;
      padding: .6rem .9rem;
      border-left: 4px solid var(--quote-border);
      background: var(--quote-bg);
      border-radius: 10px;
      color: var(--text);
    }
    .markdown-body blockquote p { margin: .3rem 0; }

    /* Disable hover highlight inside manual content */
    .content .panel-body .markdown-body *:hover {
      background: transparent !important;
      color: inherit !important;
      text-decoration-color: inherit !important;
    }
    .markdown-body a {
      color: var(--link);
      text-decoration: underline;
    }
    .markdown-body a:hover {
      text-decoration: underline;
      background: transparent;
      color: var(--link);
    }

    /* =========================
       TOC (neutral hover, no brand)
       ========================= */
    .toc .panel-body { overflow-y: auto; max-height: calc(100vh - 170px); }
    .toc nav { padding: .25rem .5rem; }
    .toc a {
      display: block;
      padding: .35rem .5rem;
      border-radius: 8px;
      color: var(--muted);
      transition: background-color .15s ease, color .15s ease;
    }
    .toc a:hover {
      background: var(--hover);
      color: var(--text);
      text-decoration: none;
    }
    .toc .level-1 { margin-left: 0; font-weight: 700; color: var(--text); }
    .toc .level-2 { margin-left: .5rem; }
    .toc .level-3 { margin-left: 1rem; }
    .toc .level-4 { margin-left: 1.5rem; font-size: .95rem; }
    .toc .level-5, .toc .level-6 { margin-left: 2rem; font-size: .9rem; }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .toc { grid-column: 1 / -1; }
      .toc .panel-body { max-height: none; }
    }

    /* =========================
       Left Swipe Drawer (25% width)
       ========================= */
    .menu-overlay {
      position: fixed; inset: 0;
      background: color-mix(in oklab, var(--bg) 40%, black 10%); /* subtle backdrop */
      display: none; z-index: 300;
    }
    .menu-overlay.open { display: block; }

    .menu-drawer {
      position: absolute; left: 0; top: 0; bottom: 0;
      width: clamp(280px, 25vw, 420px); /* ≈25% screen */
      background: var(--panel);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      transform: translateX(-100%);
      transition: transform .25s ease;
      display: grid; grid-template-rows: auto 1fr auto; /* header, body, footer */
    }
    .menu-overlay.open .menu-drawer { transform: translateX(0); }

    .menu-drawer-header {
      display: block;
      padding: .6rem .9rem; border-bottom: 1px solid var(--border);
    }
    .menu-drawer-header .brand { display: flex; align-items: center; height: 36px; }
    .menu-drawer-header .brand img { max-height: 100%; max-width: 160px; object-fit: contain; }

    .menu-drawer-body {
      padding: .6rem .9rem; overflow: auto;
    }
    /* "Index" label on its own row (below logo) */
    .menu-section-title {
      font-weight: 600; font-size: 1rem; color: var(--muted);
      margin: 0 0 .6rem 0;
    }

    .index-list { list-style: none; margin: 0; padding: 0; }
    .index-item {
      display: grid; grid-template-columns: 1fr auto; align-items: center;
      gap: .5rem; padding: .6rem .75rem; border: 1px solid var(--border);
      border-radius: 10px; margin-bottom: .6rem; cursor: pointer;
      background: transparent;
    }
    .index-item:hover { background: transparent; } /* keep neutral on hover */
    .index-item .badge {
      font-size: .75rem; color: var(--muted);
      border: 1px solid var(--border); padding: .15rem .4rem; border-radius: 999px;
    }

    .menu-drawer-footer {
      padding: .6rem .9rem; border-top: 1px solid var(--border);
    }
    .settings-row {
      display: flex; align-items: center; justify-content: space-between;
      gap: .75rem; padding: .25rem 0;
    }
    .switch {
      position: relative; width: 52px; height: 28px;
      background: color-mix(in oklab, var(--panel) 85%, white 15%);
      border: 1px solid var(--border); border-radius: 999px; cursor: pointer;
    }
    .switch .thumb {
      position: absolute; top: 2px; left: 2px;
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--text); transition: left .2s ease;
    }
    .switch[data-checked="true"] .thumb { left: 26px; }
  </style>
</head>
<body>

  <!-- ===================== HEADER ===================== -->
  <header class="site-header" aria-label="Site header">
    <!-- Menu button (opens 25% left drawer) -->
    <button class="menu-btn" id="open-menu" title="Open Menu" aria-haspopup="true" aria-controls="menu-overlay">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- Company logo (clickable → Welcome page) -->
    <div class="logo company" aria-label="Company logo">
      <img src="Company logo.png" alt="Company logo" id="logo-home" />
    </div>

    <div class="site-title" aria-label="Company name">
      LendPerfect – User Manuals
    </div>

    <div class="logo partner" aria-label="Partner logo">
      <img src="images/partner-logo.png" alt="Partner logo" />
    </div>
  </header>

  <!-- ===================== MAIN LAYOUT ===================== -->
  <main class="layout" aria-label="Main content" id="layout">
    <!-- MIDDLE: Markdown viewer -->
    <section class="panel content" aria-label="Manual content">
      <div class="panel-header">
        <h2 id="current-manual-title">Welcome</h2>
        <span id="load-status" style="color:var(--muted); font-size:.85rem;"></span>
      </div>
      <div class="panel-body">
        <article id="markdown-view" class="markdown-body" aria-live="polite">
          <!-- Welcome page content will be injected by JS on init and on logo click -->
        </article>
      </div>
    </section>

    <!-- RIGHT: Table of contents (Collapsible) -->
    <aside class="panel toc" aria-label="Table of contents" id="panel-right">
      <div class="panel-header">
        <h2>Table of Contents</h2>
        <button class="collapse-btn" id="btn-collapse-right" aria-expanded="true" aria-controls="panel-right-body" title="Collapse TOC">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Collapse
        </button>
      </div>
      <div class="panel-body" id="panel-right-body">
        <nav id="toc" aria-label="Headings in document"></nav>
      </div>
    </aside>
  </main>

  <!-- ===================== LEFT SWIPE DRAWER (25%) ===================== -->
  <div class="menu-overlay" id="menu-overlay" role="dialog" aria-modal="true" aria-label="Menu">
    <div class="menu-drawer" id="menu-drawer">
      <!-- Drawer header: company logo top-left -->
      <div class="menu-drawer-header">
        <div class="brand">
          <img src="Company logo.png" alt="Company logo" />
        </div>
      </div>

      <!-- Drawer body -->
      <div class="menu-drawer-body">
        <div class="menu-section-title">Index</div>
        <ul id="drawer-index-list" class="index-list" aria-live="polite">
          <!-- Items injected from MANUALS_DATA -->
        </ul>
      </div>

      <!-- Drawer footer: Theme switch at bottom -->
      <div class="menu-drawer-footer">
        <div class="settings-row">
          <span>Theme</span>
          <div class="switch" id="theme-switch" role="switch" aria-checked="false" tabindex="0" data-checked="false" title="Toggle Light/Dark">
            <div class="thumb" aria-hidden="true"></div>
          </div>
        </div>
        <p style="color:var(--muted); font-size:.85rem; margin:.25rem 0 0;">
          Remembers your choice via <code>localStorage</code>.
        </p>
      </div>
    </div>
  </div>

  <!-- ===================== DEPENDENCIES (correct script tags) ===================== -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <!-- ===================== PAGE LOGIC ===================== -->
  <script>
    // ===========================================================
    // Manuals list
    // - id: unique key
    // - name: display name
    // - lang: language label (badge) — will not render if value is 'Markdown'
    // - url: RAW GitHub URL (or GitHub blob URL — will be coerced)
    // ===========================================================
    const MANUALS_DATA = [
      {
        id: "pmv-scheme",
        name: "PM Vishwakarma Scheme",
        lang: "Markdown", // Hidden in UI
        url: "https://raw.githubusercontent.com/Surya-Jaganathan/PSB-PMV-scheme-user-manual/refs/heads/main/README.md"
      }
      // Add more manuals here if needed
      { id: "another", name: "Another Manual", lang: "", url: "https://github.com/org/repo/blob/main/docs/manual.md" }
    ];

    let CURRENT_MANUAL = null;

    // ===========================================================
    // Welcome page content
    // ===========================================================
    function renderWelcomePage() {
      const container = document.getElementById("markdown-view");
      document.getElementById("current-manual-title").textContent = "Welcome";
      document.getElementById("load-status").textContent = "";

      container.innerHTML = `
        <div class="placeholder" style="border:1px dashed var(--border); padding:1rem; border-radius:12px;">
          <h1 style="margin-top:0;">Welcome to the Lead Perfect user manual portal</h1>
          <p>Select the user manual from <strong>Index</strong>.</p>
          <h3>How to open the Index</h3>
          <ol>
            <li>Click the <strong>Menu</strong> button at the top-left of the screen.</li>
            <li>In the drawer that appears, under <strong>Index</strong>, click the manual you want to read.</li>
            <li>The manual will load in the middle area. Use the <strong>Table of Contents</strong> on the right to jump between sections.</li>
          </ol>
          <p><em>Tip:</em> You can return to this Welcome page anytime by clicking the <strong>company logo</strong> at the top.</p>
          <blockquote>
            For the best experience, use headings (H2, H3) consistently — the TOC is auto-generated from your document's headings.
          </blockquote>
        </div>
      `;

      // Clear TOC on welcome
      const toc = document.getElementById("toc");
      toc.innerHTML = "";
    }

    // ===========================================================
    // Index (drawer)
    // ===========================================================
    function buildDrawerIndex() {
      const listEl = document.getElementById("drawer-index-list");
      listEl.innerHTML = "";
      MANUALS_DATA.forEach(m => {
        const li = document.createElement("li");
        li.className = "index-item";
        li.setAttribute("data-id", m.id);

        const name = document.createElement("span");
        name.textContent = m.name;

        // Hide 'Markdown' label per request; show others if provided
        const lang = (m.lang || "").trim();
        if (lang && lang.toLowerCase() !== "markdown") {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = lang;
          li.appendChild(name);
          li.appendChild(badge);
        } else {
          li.appendChild(name);
        }

        li.addEventListener("click", () => {
          loadManualById(m.id);
          closeMenu();
        });
        listEl.appendChild(li);
      });
    }

    // ===========================================================
    // URL helpers for cross-repo markdown and images
    // ===========================================================
    function coerceToRaw(url) {
      // e.g., https://github.com/user/repo/blob/main/docs/file.md -> RAW
      if (/^https:\/\/github\.com\//.test(url) && url.includes('/blob/')) {
        return url.replace('https://github.com/', 'https://raw.githubusercontent.com/')
                  .replace('/blob/', '/');
      }
      return url;
    }

    function toJsDelivr(rawOrBlobUrl) {
      try {
        const m = rawOrBlobUrl.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.*)$/);
        if (m) {
          const [, user, repo, branch, path] = m;
          return `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`;
        }
        const b = rawOrBlobUrl.match(/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.*)$/);
        if (b) {
          const [, user, repo, branch, path] = b;
          return `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`;
        }
      } catch {}
      return null;
    }

    function getRepoRootFromRaw(rawUrl) {
      const m = rawUrl.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.*)$/);
      if (!m) return null;
      const [, user, repo, branch] = m;
      return `https://raw.githubusercontent.com/${user}/${repo}/${branch}/`;
    }

    async function fetchMarkdownWithFallback(originalUrl) {
      let url = coerceToRaw(originalUrl);
      let res = await fetch(url, { cache: 'no-store' }).catch(() => null);
      if (!res || !res.ok) {
        const normalized = url.replace('/refs/heads/', '/'); // fix refs/heads/main -> /main/
        if (normalized !== url) {
          url = normalized;
          res = await fetch(url, { cache: 'no-store' }).catch(() => null);
        }
      }
      if (!res || !res.ok) {
        const cdn = toJsDelivr(url);
        if (cdn) {
          url = cdn;
          res = await fetch(url, { cache: 'no-store' }).catch(() => null);
        }
      }
      if (!res || !res.ok) throw new Error(`Failed to fetch markdown from: ${originalUrl}`);
      const md = await res.text();
      return { md, workingUrl: url };
    }

    function resolveImages(container, baseRawUrl) {
      const imgs = container.querySelectorAll('img');
      const repoRoot = getRepoRootFromRaw(baseRawUrl);

      imgs.forEach(img => {
        const src = img.getAttribute('src');
        if (!src) return;

        try {
          if (/^https?:\/\//i.test(src)) {
            // Absolute URL: leave as-is but fix GitHub blob to raw
            if (/^https:\/\/github\.com\//.test(src) && src.includes('/blob/')) {
              img.src = coerceToRaw(src);
            }
          } else if (src.startsWith('/')) {
            // Root-relative: map to repo root
            if (repoRoot) img.src = repoRoot + src.replace(/^\//, '');
          } else {
            // Relative: resolve using the markdown file's base URL
            img.src = new URL(src, baseRawUrl).href;
          }
        } catch {
          const cdn = toJsDelivr(baseRawUrl);
          if (cdn) {
            try {
              const rawBasePath = new URL(baseRawUrl);
              const pathPart = rawBasePath.pathname.replace(/^\/[^\/]+\/[^\/]+\/[^\/]+\//, '');
              const cdnBase = toJsDelivr(baseRawUrl).replace(pathPart, '');
              img.src = `${cdnBase}${src.replace(/^\//, '')}`;
            } catch {}
          }
        }

        // On error, try jsDelivr fallback
        img.addEventListener('error', () => {
          const current = img.src;
          const cdn = toJsDelivr(current) || toJsDelivr(baseRawUrl);
          if (cdn) {
            try {
              if (/^https:\/\/raw\.githubusercontent\.com\//.test(current)) {
                const m = current.match(/^https:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.*)$/);
                if (m) {
                  const [, user, repo, branch, path] = m;
                  img.src = `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`;
                  return;
                }
              }
              img.src = cdn;
            } catch {}
          }
        });

        img.loading = 'lazy';
        img.decoding = 'async';
      });
    }

    // ===========================================================
    // Render Markdown + fix images
    // ===========================================================
    async function renderMarkdown(mdText) {
      const html = marked.parse(mdText, { gfm: true, breaks: false });
      const safeHtml = DOMPurify.sanitize(html, { ADD_ATTR: ["target"] });

      const container = document.getElementById("markdown-view");
      container.innerHTML = safeHtml;

      // Fix images after render
      if (CURRENT_MANUAL?.url) {
        resolveImages(container, CURRENT_MANUAL.url);
      }

      assignHeadingIdsAndBuildTOC(container);
    }

    // Assign IDs and build TOC
    function slugify(text) {
      return text.toLowerCase().trim().replace(/[^\w\s-]/g, "").replace(/\s+/g, "-");
    }
    function assignHeadingIdsAndBuildTOC(container) {
      const headings = container.querySelectorAll("h1, h2, h3, h4, h5, h6");
      const used = new Set();
      headings.forEach(h => {
        let base = slugify(h.textContent);
        let id = base || h.tagName.toLowerCase();
        let i = 2;
        while (used.has(id) || document.getElementById(id)) {
          id = `${base}-${i++}`;
        }
        used.add(id);
        h.id = id;
      });
      buildTOC(headings);
    }
    function buildTOC(headings) {
      const toc = document.getElementById("toc");
      toc.innerHTML = "";
      headings.forEach(h => {
        const level = parseInt(h.tagName.substring(1), 10);
        const a = document.createElement("a");
        a.href = `#${h.id}`;
        a.textContent = h.textContent;
        a.className = `level-${level}`;
        toc.appendChild(a);
      });
      toc.querySelectorAll("a").forEach(a => {
        a.addEventListener("click", (ev) => {
          ev.preventDefault();
          const targetId = a.getAttribute("href").slice(1);
          const el = document.getElementById(targetId);
          if (!el) return;
          el.scrollIntoView({ behavior: "smooth", block: "start" });
          history.replaceState(null, "", `#${targetId}`);
        });
      });
    }

    // ===========================================================
    // Load manual
    // ===========================================================
    async function loadManualById(id) {
      const manual = MANUALS_DATA.find(m => m.id === id);
      const statusEl = document.getElementById("load-status");
      const titleEl = document.getElementById("current-manual-title");

      if (!manual) {
        titleEl.textContent = "Manual not found";
        statusEl.textContent = "";
        document.getElementById("markdown-view").innerHTML =
          `<div class="placeholder"><p style="color:#ef4444">Error: Manual ID "${id}" not found.</p></div>`;
        return;
      }

      CURRENT_MANUAL = manual;
      titleEl.textContent = manual.name;
      statusEl.textContent = "Loading…";

      try {
        const { md, workingUrl } = await fetchMarkdownWithFallback(manual.url);
        CURRENT_MANUAL.url = workingUrl; // set working base for image resolution
        await renderMarkdown(md);
        statusEl.textContent = "Loaded ✓";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        document.getElementById("markdown-view").innerHTML =
          `<div class="placeholder">
             <p style="color:#ef4444">Failed to load the manual.</p>
             <p><strong>Tried URL:</strong></p>
             <pre>${manual.url}</pre>
             <p style="color:var(--muted)">
               If the repo is private, browsers can’t fetch RAW without auth (CORS).
               Use a public repo or proxy, or serve via jsDelivr/GitHub Pages.
             </p>
           </div>`;
      }
    }

    // ===========================================================
    // TOC collapse (button remains visible)
    // ===========================================================
    const panelRight = document.getElementById("panel-right");
    const btnRight = document.getElementById("btn-collapse-right");
    function toggleRightCollapse() {
      const isCollapsed = panelRight.classList.toggle("collapsed");
      btnRight.setAttribute("aria-expanded", String(!isCollapsed));
      btnRight.title = isCollapsed ? "Expand TOC" : "Collapse TOC";
    }
    btnRight.addEventListener("click", toggleRightCollapse);

    // ===========================================================
    // Drawer open/close
    // ===========================================================
    const overlay = document.getElementById("menu-overlay");
    const openBtn = document.getElementById("open-menu");
    const drawer = document.getElementById("menu-drawer");
    function openMenu(e) {
      if (e) e.stopPropagation();
      overlay.classList.add("open");
    }
    function closeMenu() {
      overlay.classList.remove("open");
    }
    openBtn.addEventListener("click", openMenu);
    overlay.addEventListener("click", (e) => { if (!drawer.contains(e.target)) closeMenu(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeMenu(); });

    // ===========================================================
    // Theme switch
    // ===========================================================
    const themeSwitch = document.getElementById("theme-switch");
    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      const checked = theme === "dark";
      themeSwitch.dataset.checked = String(checked);
      themeSwitch.setAttribute("aria-checked", String(checked));
      localStorage.setItem("theme", theme);
    }
    function initTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "light" || saved === "dark") applyTheme(saved);
      else applyTheme(window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(current === "light" ? "dark" : "light");
    }
    themeSwitch.addEventListener("click", toggleTheme);
    themeSwitch.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleTheme(); }
    });

    // ===========================================================
    // Logo → Welcome
    // ===========================================================
    document.getElementById("logo-home").addEventListener("click", (e) => {
      e.preventDefault();
      closeMenu();
      renderWelcomePage();
    });

    // ===========================================================
    // Init: theme, index, welcome page
    // ===========================================================
    function init() {
      initTheme();
      buildDrawerIndex();
      renderWelcomePage(); // default landing page
    }
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</

